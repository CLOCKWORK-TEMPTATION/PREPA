# ุฏููู ููุฒุงุช ูุธุงู ุงูุฑุงูู - ุงูุฅุตุฏุงุฑ 4.0

## ููุฑุณ ุงููุญุชููุงุช

1. [ูุธุฑุฉ ุนุงูุฉ](#ูุธุฑุฉ-ุนุงูุฉ)
2. [ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุฅุตุฏุงุฑ 4.0](#ุงูููุฒุงุช-ุงูุฌุฏูุฏุฉ-ูู-ุงูุฅุตุฏุงุฑ-40)
3. [ุงูุจููุฉ ุงููุนูุงุฑูุฉ](#ุงูุจููุฉ-ุงููุนูุงุฑูุฉ)
4. [ุฏููู ุงูุงุณุชุฎุฏุงู](#ุฏููู-ุงูุงุณุชุฎุฏุงู)
5. [ุฃูุซูุฉ ุนูููุฉ](#ุฃูุซูุฉ-ุนูููุฉ)
6. [ูุนุงููุฑ ุฌูุฏุฉ ุงูุจูุงูุงุช](#ูุนุงููุฑ-ุฌูุฏุฉ-ุงูุจูุงูุงุช)
7. [ุฏููู ุงุณุชูุดุงู ุงูุฃุฎุทุงุก](#ุฏููู-ุงุณุชูุดุงู-ุงูุฃุฎุทุงุก)
8. [ุงููุฑุฌุน ุงูููู](#ุงููุฑุฌุน-ุงูููู)

---

## ูุธุฑุฉ ุนุงูุฉ

### ูุง ูู ูุธุงู ุงูุฑุงููุ

ูุธุงู **ุงูุฑุงูู** ูู ูุธุงู ูุชูุฏู ููุนุงูุฌุฉ ุงูุณููุงุฑูููุงุช ุงูุนุฑุจูุฉ ูุชุญููููุง ุฅูู ูุฌููุนุงุช ุจูุงูุงุช ุนุงููุฉ ุงูุฌูุฏุฉ ูุชุฏุฑูุจ ุงูููุงุฐุฌ ุงููุบููุฉ ุงููุจูุฑุฉ (LLMs). ูุฏุนู ุงููุธุงู ูุนุงูุฌุฉ ูููุงุช TXT ู PDF ููููุชุฌ ูุฌููุนุงุช ุจูุงูุงุช ุจุตูุบ ูุชุนุฏุฏุฉ ูุซู Alpaca ู ShareGPT ู JSONL ู CSV.

### ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

- **ูุนุงูุฌุฉ ุงูุณููุงุฑูููุงุช ุงูุนุฑุจูุฉ**: ุฏุนู ูุงูู ูููุตูุต ุงูุนุฑุจูุฉ RTL
- **ุชุญููู ุงููุดุงุนุฑ**: ุชุญููู ุนููู ูููุดุงุนุฑ ูู ุงูุญูุงุฑุงุช
- **ุจูุงุก ุดุจูุงุช ุงูุนูุงูุงุช**: ุฅูุดุงุก ุฑุณูู ุจูุงููุฉ ููุนูุงูุงุช ุจูู ุงูุดุฎุตูุงุช
- **ุชุตุฏูุฑ ูุชุนุฏุฏ ุงูุตูุบ**: ุฏุนู Alpaca, ShareGPT, JSONL, CSV
- **ุชูุงูู ูุน Gemini API**: ุชุญููู ูุชูุฏู ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู

---

## ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุฅุตุฏุงุฑ 4.0

### 1. ุชูุญูุฏ ุงูููุงูุงุช (Entity Canonicalization)

#### ุงููุตู
ุชููู ูุฐู ุงูููุฒุฉ ุจุฏูุฌ ุฃุณูุงุก ุงูุดุฎุตูุงุช ุงููุชุดุงุจูุฉ ุชููุงุฆูุงู ูุถูุงู ุงุชุณุงู ุงูุจูุงูุงุช.

#### ููู ุชุนููุ
- ุญุณุงุจ ูุณุจุฉ ุงูุชุดุงุจู ุจูู ุฃุณูุงุก ุงูุดุฎุตูุงุช ุจุงุณุชุฎุฏุงู ููุชุจุฉ `rapidfuzz` ุฃู `difflib`
- ุฅุฐุง ูุงูุช ูุณุจุฉ ุงูุชุดุงุจู ุฃุนูู ูู **85%**ุ ูุชู ุฏูุฌ ุงูุฃุณูุงุก
- ููุฎุชุงุฑ ุงูุงุณู ุงูุฃูุซุฑ ุชูุฑุงุฑุงู ูุงุณู ูุงูููู
- ุฅุฐุง ุชุณุงูุช ุงูุชูุฑุงุฑุงุชุ ููุฎุชุงุฑ ุงูุงุณู ุงูุฃุทูู

#### ูุซุงู ุนููู
```
ูุจู ุงูุชุทุจูุน:
- "ุฑุฃูุช" (50 ูุฑุฉ)
- "ุฑุฃูุช ุนุจุฏ ุงููุฌูุฏ" (30 ูุฑุฉ)
- "ุฑุฃูุช ุงููุฌุงู" (10 ูุฑุงุช)

ุจุนุฏ ุงูุชุทุจูุน:
- ุฌููุน ุงูุฃุณูุงุก โ "ุฑุฃูุช ุนุจุฏ ุงููุฌูุฏ"
```

#### ุงูุงุณุชุฎุฏุงู
```python
from screenplay_to_dataset1 import EntityCanonicalizer

# ุฅูุดุงุก ูุซูู ูุน ูุณุจุฉ ุชุดุงุจู ูุฎุตุตุฉ
canonicalizer = EntityCanonicalizer(similarity_threshold=0.85)

# ุจูุงุก ูุงููุณ ุงูุชุทุจูุน
canonical_map = canonicalizer.build_canonical_map(scenes)

# ุชุทุจูู ุงูุชุทุจูุน
normalized_scenes = canonicalizer.apply_normalization(scenes)

# ุชุตุฏูุฑ ุณุฌู ุนูููุงุช ุงูุฏูุฌ
canonicalizer.export_merge_log(Path("merge_log.json"))
```

#### ูููุงุช ุงูุณุฌู
ูุชู ุญูุธ ุณุฌู ุนูููุงุช ุงูุฏูุฌ ุชููุงุฆูุงู ุจุงูุชูุณูู ุงูุชุงูู:
```json
{
  "total_names": 45,
  "merged_names": 12,
  "merge_details": [
    {
      "original": "ุฑุฃูุช",
      "canonical": "ุฑุฃูุช ุนุจุฏ ุงููุฌูุฏ",
      "similarity": 0.87
    }
  ]
}
```

---

### 2. ุฅุซุฑุงุก ุงูุณูุงู (Context Enrichment)

#### ุงููุตู
ุชูุถูู ูุฐู ุงูููุฒุฉ ุงูุณูุงู ุงููุตูู ูููุดูุฏ ุฅูู ุจูุงูุงุช ุงูุชุฏุฑูุจุ ููุง ููุญุณูู ููู ุงููููุฐุฌ ููุธุฑูู ุงููุญูุทุฉ ุจุงูุญูุงุฑ.

#### ุงูููููุงุช
1. **ุขุฎุฑ ุณุทุฑ ูุตูู ููู**: ููุณุชุฎุฑุฌ ูู ูุงุฆูุฉ `actions`
2. **ูุนูููุงุช ุงููุดูุฏ**: ุงูููุงูุ ุงูุฒูุงูุ ููุน ุงูุฏุงุฎู/ุงูุฎุงุฑุฌ
3. **ุงููุชุฑุฉ ุงูุฒูููุฉ**: ุฅุฐุง ูุงูุช ูุชููุฑุฉ

#### ุชูุณูู ุงูุฅุฏุฎุงู ุงููุญุณูู
```
ุงูููุงู: {location} - {time_of_day}. {int_ext}.
[ุณูุงู: {last_action}]

ุณูุงู ุงูุญุฏูุซ ุงูุณุงุจู:
{previous_dialogue}

ุงููุชุญุฏุซ: {speaker}
```

#### ุงูุงุณุชุฎุฏุงู
```python
from screenplay_to_dataset1 import DatasetExporter

exporter = DatasetExporter("output_dir")

# ุชุตุฏูุฑ ุจุตูุบุฉ Alpaca ูุน ุงูุณูุงู ุงููุญุณูู
exporter.export_contextual_alpaca(scenes)
```

#### ูุซุงู ุนูู ุงููุฎุฑุฌุงุช
```json
{
  "instruction": "ุฃููู ุงูุญูุงุฑ ุงูุชุงูู ุจูุง ููุงุณุจ ุงูุดุฎุตูุฉ ูุงูุณูุงู",
  "input": "ุงูููุงู: ุบุฑูุฉ ุงููุนูุดุฉ - ููู. ุฏุงุฎูู.\n[ุณูุงู: ุชุฏุฎู ุณููุฑ ุงูููุฒู ุจูุฏูุก ูุชูุธุฑ ุญูููุง ุจููู]\n\nุณูุงู ุงูุญุฏูุซ ุงูุณุงุจู:\nุฃุญูุฏ: ุฃูู ููุชูุ\n\nุงููุชุญุฏุซ: ุณููุฑ",
  "output": "ููุช ุนูุฏ ุฃูู... ููุงุฐุง ุชุณุฃูุ"
}
```

---

### 3. ููุชุฑุฉ ุงูุฌูุฏุฉ (Quality Filtering)

#### ุงููุตู
ุชูุฒูู ูุฐู ุงูููุฒุฉ ุงูุญูุงุฑุงุช ููุฎูุถุฉ ุงููููุฉ ุงููุนูููุงุชูุฉ ุชููุงุฆูุงู ููุญุตูู ุนูู ุจูุงูุงุช ุชุฏุฑูุจ ุนุงููุฉ ุงูุฌูุฏุฉ.

#### ูุนุงููุฑ ุงูููุชุฑุฉ
| ุงููุนูุงุฑ | ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ | ุงูุชุฃุซูุฑ |
|---------|------------------|---------|
| ุงูุญุฏ ุงูุฃุฏูู ูููููุงุช | 3 ูููุงุช | ุงูุญูุงุฑุงุช ุงูุฃูุตุฑ ุชูุญุฐู |
| ุนุชุจุฉ ุงููุดุงุนุฑ ุงููููุฉ | 0.8 | ุงูุญูุงุฑุงุช ุงููุตูุฑุฉ ุฐุงุช ุงููุดุงุนุฑ ุงููููุฉ ุชูุญูุธ |

#### ููุงุนุฏ ุงูููุชุฑุฉ
1. **ุงููุงุนุฏุฉ 1**: ุงูุญูุงุฑุงุช โฅ 3 ูููุงุช โ **ุชูุญูุธ**
2. **ุงููุงุนุฏุฉ 2**: ุงูุญูุงุฑุงุช < 3 ูููุงุช + ุฏุฑุฌุฉ ูุดุงุนุฑ โฅ 0.8 โ **ุชูุญูุธ**
3. **ุฎูุงู ุฐูู** โ **ุชูุญุฐู**

#### ุงูุงุณุชุฎุฏุงู
```python
from screenplay_to_dataset1 import QualityFilter

# ุฅูุดุงุก ููุชุฑ ูุน ูุนุงููุฑ ูุฎุตุตุฉ
quality_filter = QualityFilter(
    min_words=3,
    high_sentiment_threshold=0.8
)

# ุชุทุจูู ุงูููุชุฑุฉ
filtered_scenes = quality_filter.filter_scenes(scenes)

# ุงูุญุตูู ุนูู ุงูุฅุญุตุงุฆูุงุช
stats = quality_filter.get_filter_stats()
print(f"ุชู ุญุฐู {stats['filtered_count']} ุญูุงุฑ")
```

#### ุฃูุซูุฉ ุนูู ุงูููุชุฑุฉ
```
# ุชูุญุฐู (ุฃูู ูู 3 ูููุงุชุ ูุดุงุนุฑ ููุฎูุถุฉ):
"ูุนู" โ sentiment_score: 0.2
"ุฃููุงู" โ sentiment_score: 0.1

# ุชูุญูุธ (ุฃูู ูู 3 ูููุงุชุ ูุดุงุนุฑ ุนุงููุฉ):
"ูุง!" โ sentiment_score: 0.95 (ุบุถุจ ุดุฏูุฏ)
"ุฃุญุจู" โ sentiment_score: 0.92 (ุญุจ ููู)

# ุชูุญูุธ (3 ูููุงุช ุฃู ุฃูุซุฑ):
"ููู ุญุงูู ุงููููุ" โ 3 ูููุงุช
```

---

### 4. ุงูููุชุงุฏุงุชุง ุงูุฒูููุฉ (Temporal Metadata)

#### ุงููุตู
ุชุณุชุฎุฑุฌ ูุฐู ุงูููุฒุฉ ุงููุชุฑุงุช ุงูุฒูููุฉ ูู ุงููุดุงูุฏุ ููุง ููุณุงุนุฏ ูู ุชุญููู ุงูุชุณูุณู ุงูุฒููู ููุฃุญุฏุงุซ (ูุซู ุงูููุงุด ุจุงู).

#### ููู ุชุนููุ
1. ุงูุจุญุซ ุนู ุงูุณููุงุช ูู ุนูุงููู ุงููุดุงูุฏ ุจุงุณุชุฎุฏุงู ุงูููุท: `\b(19|20)\d{2}\b`
2. ุฅุฐุง ูู ุชููุฌุฏ ุณูุฉุ ูููุฑุซ ุงููุดูุฏ ุงูุณูุฉ ูู ุงููุดูุฏ ุงูุณุงุจู
3. ุฅุฐุง ูู ุชุชููุฑ ุฃู ุณูุฉุ ุชููุถุน ุงููููุฉ "ุบูุฑ ูุญุฏุฏ"

#### ุงูุงุณุชุฎุฏุงู
```python
# ูุชู ุงุณุชุฎุฑุงุฌ ุงููุชุฑุฉ ุงูุฒูููุฉ ุชููุงุฆูุงู ุฃุซูุงุก ุงูุชุญููู
from screenplay_to_dataset1 import ScreenplayParser

parser = ScreenplayParser()
scenes = parser.parse(lines)

# ุงููุตูู ูููุชุฑุฉ ุงูุฒูููุฉ
for scene in scenes:
    print(f"ุงููุดูุฏ {scene.scene_number}: {scene.time_period}")
```

#### ูุฎุฑุฌุงุช JSONL
```json
{
  "scene_id": "S0001",
  "heading": "ุฏุงุฎูู - ููุฒู - 1986 - ููู",
  "location": "ููุฒู",
  "time_of_day": "ููู",
  "time_period": "1986",
  "dialogue": [...]
}
```

---

## ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### ูููุฐุฌ Pipeline

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        Ingestor                              โ
โ            (ูุฑุงุกุฉ ุงููููุงุช: TXT/PDF)                         โ
โ  - TextFileIngestor: ูุฑุงุกุฉ ูููุงุช TXT                        โ
โ  - DoclingIngestor: ูุฑุงุกุฉ ูููุงุช PDF                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        Parser                                โ
โ            (ุชุญููู ุงููุตูุต ูุงุณุชุฎุฑุงุฌ ุงููุดุงูุฏ)                  โ
โ  - ุงุณุชุฎุฑุงุฌ ุงููุดุงูุฏ ูุงูุญูุงุฑุงุช                                โ
โ  - ุงุณุชุฎุฑุงุฌ ุงูููุชุงุฏุงุชุง ุงูุฒูููุฉ (v4.0)                       โ
โ  - ุชุญุณูู ุงุณุชุฎุฑุงุฌ ุงูุฃุณุทุฑ ุงููุตููุฉ (v4.0)                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       Enricher                               โ
โ            (ุฅุซุฑุงุก ุงูุจูุงูุงุช)                                 โ
โ  - ุฅุถุงูุฉ ุงูุชุถูููุงุช (Embeddings)                             โ
โ  - ุชุญููู ุงููุดุงุนุฑ (Sentiment Analysis)                       โ
โ  - ุชูุญูุฏ ุงูููุงูุงุช (v4.0)                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       Exporter                               โ
โ            (ุชุตุฏูุฑ ุงูุจูุงูุงุช)                                 โ
โ  - ููุชุฑุฉ ุงูุฌูุฏุฉ (v4.0)                                     โ
โ  - ุฅุซุฑุงุก ุงูุณูุงู ูู Alpaca (v4.0)                           โ
โ  - ุชุตุฏูุฑ: Alpaca, ShareGPT, JSONL, CSV                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ููุงุฐุฌ ุงูุจูุงูุงุช

#### DialogueTurn
```python
@dataclass
class DialogueTurn:
    scene_id: str          # ูุนุฑู ุงููุดูุฏ
    turn_id: int           # ูุนุฑู ุงูุญูุงุฑ
    speaker: str           # ุงุณู ุงููุชุญุฏุซ (ููุทุจูุน ูู v4.0)
    text: str              # ูุต ุงูุญูุงุฑ
    normalized_text: str   # ุงููุต ุงููุทุจูุน
    sentiment: str         # ููุน ุงููุดุงุนุฑ
    sentiment_score: float # ุฏุฑุฌุฉ ุงููุดุงุนุฑ (0.0-1.0)
    original_speaker: str  # ุงูุงุณู ุงูุฃุตูู ูุจู ุงูุชุทุจูุน (v4.0)
```

#### Scene
```python
@dataclass
class Scene:
    scene_id: str              # ูุนุฑู ูุฑูุฏ
    scene_number: int          # ุฑูู ุงููุดูุฏ
    heading: str               # ุนููุงู ุงููุดูุฏ
    location: str              # ุงููููุน
    time_of_day: str           # ุงูููุช (ููุงุฑ/ููู)
    int_ext: str               # ุฏุงุฎูู/ุฎุงุฑุฌู
    time_period: str           # ุงููุชุฑุฉ ุงูุฒูููุฉ (v4.0)
    actions: List[str]         # ุงูุฃุณุทุฑ ุงููุตููุฉ
    dialogue: List[DialogueTurn]  # ุงูุญูุงุฑุงุช
    characters: List[str]      # ุงูุดุฎุตูุงุช
    full_text: str             # ุงููุต ุงููุงูู
    embedding: List[float]     # ุงูุชุถููู
```

---

## ุฏููู ุงูุงุณุชุฎุฏุงู

### ุงูุชุซุจูุช

#### ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ
```bash
pip install pandas networkx sentence-transformers transformers
```

#### ุงููุชุทูุจุงุช ุงูุฅุถุงููุฉ ููููุฒุงุช ุงูุฌุฏูุฏุฉ (v4.0)
```bash
pip install rapidfuzz hypothesis
```

#### ุงููุชุทูุจุงุช ุงูุงุฎุชูุงุฑูุฉ
```bash
pip install google-genai docling
```

### ุงูุงุณุชุฎุฏุงู ุงูุฃุณุงุณู

#### ูุนุงูุฌุฉ ููู ุณููุงุฑูู
```python
from screenplay_to_dataset1 import main

# ูุนุงูุฌุฉ ููู ูุงุญุฏ
main("screenplay.txt", "output_dir")
```

#### ูุนุงูุฌุฉ ูุฎุตุตุฉ
```python
from screenplay_to_dataset1 import (
    TextFileIngestor,
    ScreenplayParser,
    AIEnricher,
    DatasetExporter
)

# 1. ูุฑุงุกุฉ ุงูููู
ingestor = TextFileIngestor()
lines = ingestor.ingest("screenplay.txt")

# 2. ุชุญููู ุงููุต
parser = ScreenplayParser()
scenes = parser.parse(lines)

# 3. ุฅุซุฑุงุก ุงูุจูุงูุงุช
enricher = AIEnricher()
enriched_scenes = enricher.enrich(scenes)

# 4. ุชุตุฏูุฑ ุงูุจูุงูุงุช
exporter = DatasetExporter("output_dir")
exporter.export_contextual_alpaca(enriched_scenes)
exporter.export_sharegpt(enriched_scenes)
exporter.export_rag_jsonl(enriched_scenes)
```

### ุชูููู ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

#### ุชูููู ุชูุญูุฏ ุงูููุงูุงุช
```python
from screenplay_to_dataset1 import EntityCanonicalizer

# ูุณุจุฉ ุชุดุงุจู ูุฎุตุตุฉ (ุงูุชุฑุงุถู: 0.85)
canonicalizer = EntityCanonicalizer(similarity_threshold=0.90)
```

#### ุชูููู ููุชุฑุฉ ุงูุฌูุฏุฉ
```python
from screenplay_to_dataset1 import QualityFilter

# ูุนุงููุฑ ูุฎุตุตุฉ
quality_filter = QualityFilter(
    min_words=5,                    # ุงูุญุฏ ุงูุฃุฏูู 5 ูููุงุช
    high_sentiment_threshold=0.75   # ุนุชุจุฉ ุงููุดุงุนุฑ 75%
)
```

---

## ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ูุนุงูุฌุฉ ุณููุงุฑูู ูุงูู ูุน ุฌููุน ุงูุชุญุณููุงุช

```python
from pathlib import Path
from screenplay_to_dataset1 import (
    TextFileIngestor,
    ScreenplayParser,
    AIEnricher,
    DatasetExporter,
    EntityCanonicalizer,
    QualityFilter
)

def process_screenplay(input_file: str, output_dir: str):
    """ูุนุงูุฌุฉ ุณููุงุฑูู ูุงูู ูุน ุฌููุน ุชุญุณููุงุช v4.0"""

    # ุฅูุดุงุก ูุฌูุฏ ุงููุฎุฑุฌุงุช
    output_path = Path(output_dir)
    output_path.mkdir(exist_ok=True)

    # 1. ูุฑุงุกุฉ ุงูููู
    print("๐ ูุฑุงุกุฉ ุงูููู...")
    ingestor = TextFileIngestor()
    lines = ingestor.ingest(input_file)

    # 2. ุชุญููู ุงููุต
    print("๐ ุชุญููู ุงูุณููุงุฑูู...")
    parser = ScreenplayParser()
    scenes = parser.parse(lines)
    print(f"   ุชู ุงุณุชุฎุฑุงุฌ {len(scenes)} ูุดูุฏ")

    # 3. ุชูุญูุฏ ุงูููุงูุงุช
    print("๐ ุชูุญูุฏ ุฃุณูุงุก ุงูุดุฎุตูุงุช...")
    canonicalizer = EntityCanonicalizer(similarity_threshold=0.85)
    scenes = canonicalizer.apply_normalization(scenes)
    canonicalizer.export_merge_log(output_path / "entity_merge_log.json")

    # 4. ุฅุซุฑุงุก ุงูุจูุงูุงุช
    print("โจ ุฅุซุฑุงุก ุงูุจูุงูุงุช...")
    enricher = AIEnricher()
    scenes = enricher.enrich(scenes)

    # 5. ููุชุฑุฉ ุงูุฌูุฏุฉ
    print("๐ง ููุชุฑุฉ ุงูุฌูุฏุฉ...")
    quality_filter = QualityFilter(min_words=3)
    scenes = quality_filter.filter_scenes(scenes)
    stats = quality_filter.get_filter_stats()
    print(f"   ุชู ุญุฐู {stats['filtered_count']} ุญูุงุฑ ููุฎูุถ ุงูุฌูุฏุฉ")

    # 6. ุชุตุฏูุฑ ุงูุจูุงูุงุช
    print("๐ค ุชุตุฏูุฑ ุงูุจูุงูุงุช...")
    exporter = DatasetExporter(output_dir)
    exporter.export_contextual_alpaca(scenes)
    exporter.export_sharegpt(scenes)
    exporter.export_rag_jsonl(scenes)
    exporter.export_dialogue_csv(scenes)

    # 7. ุจูุงุก ุดุจูุฉ ุงูุนูุงูุงุช
    print("๐ธ๏ธ ุจูุงุก ุดุจูุฉ ุงูุนูุงูุงุช...")
    graph = enricher.build_social_graph(scenes)
    exporter.export_stats(graph)

    print("โ ุงูุชููุช ุงููุนุงูุฌุฉ ุจูุฌุงุญ!")
    return scenes

# ุชุดุบูู ุงููุนุงูุฌุฉ
scenes = process_screenplay("screenplay.txt", "output")
```

### ูุซุงู 2: ุชุญููู ุงููุชุฑุงุช ุงูุฒูููุฉ

```python
from screenplay_to_dataset1 import ScreenplayParser

def analyze_time_periods(input_file: str):
    """ุชุญููู ุงููุชุฑุงุช ุงูุฒูููุฉ ูู ุงูุณููุงุฑูู"""

    ingestor = TextFileIngestor()
    lines = ingestor.ingest(input_file)

    parser = ScreenplayParser()
    scenes = parser.parse(lines)

    # ุชุญููู ุงููุชุฑุงุช ุงูุฒูููุฉ
    time_periods = {}
    for scene in scenes:
        period = scene.time_period
        if period not in time_periods:
            time_periods[period] = []
        time_periods[period].append(scene.scene_number)

    print("๐ ุชุญููู ุงููุชุฑุงุช ุงูุฒูููุฉ:")
    print("-" * 40)
    for period, scene_numbers in sorted(time_periods.items()):
        print(f"{period}: ุงููุดุงูุฏ {scene_numbers}")

    return time_periods

# ุชุดุบูู ุงูุชุญููู
analyze_time_periods("screenplay.txt")
```

### ูุซุงู 3: ุชุญููู ุฌูุฏุฉ ุงูุญูุงุฑุงุช

```python
from screenplay_to_dataset1 import QualityFilter, count_arabic_words

def analyze_dialogue_quality(scenes):
    """ุชุญููู ุฌูุฏุฉ ุงูุญูุงุฑุงุช ูู ุงูุณููุงุฑูู"""

    total_dialogues = 0
    short_dialogues = 0
    emotional_short = 0
    quality_scores = []

    for scene in scenes:
        for turn in scene.dialogue:
            total_dialogues += 1
            word_count = count_arabic_words(turn.text)

            if word_count < 3:
                short_dialogues += 1
                if turn.sentiment_score >= 0.8:
                    emotional_short += 1

            # ุญุณุงุจ ุฏุฑุฌุฉ ุงูุฌูุฏุฉ
            quality = min(word_count / 10, 1.0) * 0.5 + turn.sentiment_score * 0.5
            quality_scores.append(quality)

    avg_quality = sum(quality_scores) / len(quality_scores) if quality_scores else 0

    print("๐ ุชุญููู ุฌูุฏุฉ ุงูุญูุงุฑุงุช:")
    print("-" * 40)
    print(f"ุฅุฌูุงูู ุงูุญูุงุฑุงุช: {total_dialogues}")
    print(f"ุงูุญูุงุฑุงุช ุงููุตูุฑุฉ (<3 ูููุงุช): {short_dialogues}")
    print(f"ุงูุญูุงุฑุงุช ุงููุตูุฑุฉ ุงูุนุงุทููุฉ: {emotional_short}")
    print(f"ูุชูุณุท ุฏุฑุฌุฉ ุงูุฌูุฏุฉ: {avg_quality:.2f}")

    return {
        "total": total_dialogues,
        "short": short_dialogues,
        "emotional_short": emotional_short,
        "avg_quality": avg_quality
    }
```

---

## ูุนุงููุฑ ุฌูุฏุฉ ุงูุจูุงูุงุช

### ูุนุงููุฑ ุงููุจูู

#### 1. ุชูุญูุฏ ุงูููุงูุงุช
| ุงููุนูุงุฑ | ุงูุญุฏ | ุงููุตู |
|---------|------|-------|
| ูุณุจุฉ ุงูุชุดุงุจู | โฅ 85% | ููุฏูุฌ ุงูุชููุงุฆู |
| ุงูุญุฏ ุงูุฃุฏูู ููุชูุฑุงุฑ | 1 | ุฃู ุงุณู ูุธูุฑ ูุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู |
| ุชุณุฌูู ุงูุฏูุฌ | 100% | ุฌููุน ุนูููุงุช ุงูุฏูุฌ ูุณุฌูุฉ |

#### 2. ุฌูุฏุฉ ุงูุญูุงุฑุงุช
| ุงููุนูุงุฑ | ุงูุญุฏ | ุงููุตู |
|---------|------|-------|
| ุงูุญุฏ ุงูุฃุฏูู ูููููุงุช | 3 ูููุงุช | ููุญูุงุฑุงุช ุงูุนุงุฏูุฉ |
| ุนุชุจุฉ ุงููุดุงุนุฑ | โฅ 0.8 | ููุงุญุชูุงุธ ุจุงูุญูุงุฑุงุช ุงููุตูุฑุฉ |
| ูุณุจุฉ ุงูุญุฐู ุงูููุจููุฉ | โค 30% | ููุญูุงุธ ุนูู ุญุฌู ุงูุจูุงูุงุช |

#### 3. ุฅุซุฑุงุก ุงูุณูุงู
| ุงููุนูุงุฑ | ุงูุญุฏ | ุงููุตู |
|---------|------|-------|
| ุทูู ุงูุณุทุฑ ุงููุตูู | โฅ 10 ุฃุญุฑู | ููุงุนุชุจุงุฑ "ููู" |
| ุชุถููู ุงูููุงู | 100% | ุฌููุน ุงููุดุงูุฏ ุชุชุถูู ุงูููุงู |
| ุชุถููู ุงูุฒูุงู | 100% | ุฌููุน ุงููุดุงูุฏ ุชุชุถูู ุงูููุช |

#### 4. ุงูููุชุงุฏุงุชุง ุงูุฒูููุฉ
| ุงููุนูุงุฑ | ุงูุญุฏ | ุงููุตู |
|---------|------|-------|
| ูุทุงู ุงูุณููุงุช | 1900-2099 | ุงูุณููุงุช ุงูููุจููุฉ |
| ุงููุฑุงุซุฉ | ูุชุชุงุจุนุฉ | ูู ุงููุดูุฏ ุงูุณุงุจู |
| ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ | "ุบูุฑ ูุญุฏุฏ" | ุนูุฏ ุนุฏู ุชููุฑ ุงูุณูุฉ |

### ูุคุดุฑุงุช ุงูุฃุฏุงุก

```python
# ูุซุงู ุนูู ููุงุณ ูุคุดุฑุงุช ุงูุฃุฏุงุก
def measure_quality_metrics(scenes):
    """ููุงุณ ูุคุดุฑุงุช ุฌูุฏุฉ ุงูุจูุงูุงุช"""

    metrics = {
        "total_scenes": len(scenes),
        "total_dialogues": 0,
        "unique_characters": set(),
        "avg_dialogue_length": 0,
        "time_periods_found": 0,
        "context_coverage": 0
    }

    total_words = 0
    scenes_with_time = 0
    scenes_with_context = 0

    for scene in scenes:
        metrics["total_dialogues"] += len(scene.dialogue)
        metrics["unique_characters"].update(scene.characters)

        for turn in scene.dialogue:
            total_words += count_arabic_words(turn.text)

        if scene.time_period != "ุบูุฑ ูุญุฏุฏ":
            scenes_with_time += 1

        if scene.actions:
            scenes_with_context += 1

    if metrics["total_dialogues"] > 0:
        metrics["avg_dialogue_length"] = total_words / metrics["total_dialogues"]

    metrics["unique_characters"] = len(metrics["unique_characters"])
    metrics["time_periods_found"] = scenes_with_time
    metrics["context_coverage"] = scenes_with_context / len(scenes) if scenes else 0

    return metrics
```

---

## ุฏููู ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูุญููููุง

#### 1. ุฎุทุฃ ุงุณุชูุฑุงุฏ ุงูููุชุจุงุช

**ุงููุดููุฉ:**
```
ImportError: No module named 'rapidfuzz'
```

**ุงูุญู:**
```bash
pip install rapidfuzz
```

**ุญู ุจุฏูู:** ุงููุธุงู ูุชุนุงูู ูุน ูุฐุง ุชููุงุฆูุงู ููุณุชุฎุฏู `difflib` ูุจุฏูู.

---

#### 2. ูุดู ุชุญููู ุงููุดุงุนุฑ

**ุงููุดููุฉ:**
```
Warning: ูุดู ุชุญููู ุงููุดุงุนุฑ - ุงููุชุงุจุนุฉ ุจุฏูู ุชุญููู
```

**ุงูุญู:**
1. ุชุฃูุฏ ูู ุชุซุจูุช `transformers`:
   ```bash
   pip install transformers torch
   ```
2. ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ูุชุญููู ุงููููุฐุฌ
3. ุชุญูู ูู ุชููุฑ ุฐุงูุฑุฉ ูุงููุฉ (GPU/RAM)

**ููุงุญุธุฉ:** ููุชุฑุฉ ุงูุฌูุฏุฉ ุณุชุญุชูุธ ุจุฌููุน ุงูุญูุงุฑุงุช ุงููุตูุฑุฉ ุฅุฐุง ูู ูุชููุฑ ุชุญููู ุงููุดุงุนุฑ.

---

#### 3. ูุดู ูุฑุงุกุฉ ููู PDF

**ุงููุดููุฉ:**
```
Error: ูุดู ูู ูุฑุงุกุฉ ููู PDF
```

**ุงูุญู:**
1. ุชุฃูุฏ ูู ุชุซุจูุช `docling`:
   ```bash
   pip install docling
   ```
2. ุชุญูู ูู ุตุญุฉ ููู PDF
3. ุฌุฑุจ ุชุญููู PDF ุฅูู TXT ุฃููุงู:
   ```python
   from txt_to_pdf_converter import convert_pdf_to_txt
   convert_pdf_to_txt("screenplay.pdf", "screenplay.txt")
   ```

---

#### 4. ุจูุงูุงุช ูุฎุฑุฌุงุช ูุงุฑุบุฉ

**ุงููุดููุฉ:**
ูุง ุชูุฌุฏ ุญูุงุฑุงุช ูู ุงููููุงุช ุงูููุตุฏูุฑุฉ.

**ุงูุญู:**
1. ุชุญูู ูู ุชูุณูู ุงูุณููุงุฑูู:
   - ูุฌุจ ุฃู ุชุจุฏุฃ ุนูุงููู ุงููุดุงูุฏ ุจู "ูุดูุฏ" ุฃู "ุฏุงุฎูู" ุฃู "ุฎุงุฑุฌู"
   - ุฃุณูุงุก ุงูุดุฎุตูุงุช ูุฌุจ ุฃู ุชููู ูู ุณุทุฑ ูููุตู

2. ุฑุงุฌุน ููู ุงูุณุฌู ููุชุญูู ูู ุฃุฎุทุงุก ุงูุชุญููู

3. ุฌุฑุจ ุฎูุถ ูุนุงููุฑ ููุชุฑุฉ ุงูุฌูุฏุฉ:
   ```python
   quality_filter = QualityFilter(min_words=1)
   ```

---

#### 5. ุฐุงูุฑุฉ ุบูุฑ ูุงููุฉ

**ุงููุดููุฉ:**
```
MemoryError: Unable to allocate memory
```

**ุงูุญู:**
1. ูุนุงูุฌุฉ ุงููููุงุช ุงููุจูุฑุฉ ุนูู ุฏูุนุงุช:
   ```python
   def process_in_chunks(lines, chunk_size=1000):
       for i in range(0, len(lines), chunk_size):
           chunk = lines[i:i+chunk_size]
           yield parser.parse(chunk)
   ```

2. ุชุนุทูู ุงูุชุถูููุงุช ุฅุฐุง ูู ุชูู ุถุฑูุฑูุฉ:
   ```python
   enricher = AIEnricher(skip_embeddings=True)
   ```

---

#### 6. ุชูุญูุฏ ุงูููุงูุงุช ุบูุฑ ุตุญูุญ

**ุงููุดููุฉ:**
ุฏูุฌ ุฃุณูุงุก ูุง ูุฌุจ ุฏูุฌูุง.

**ุงูุญู:**
1. ุฑูุน ูุณุจุฉ ุงูุชุดุงุจู:
   ```python
   canonicalizer = EntityCanonicalizer(similarity_threshold=0.95)
   ```

2. ูุฑุงุฌุนุฉ ุณุฌู ุงูุฏูุฌ:
   ```python
   # ุฑุงุฌุน entity_merge_log.json
   # ูุฃุถู ุงุณุชุซูุงุกุงุช ูุฏููุงู ุฅุฐุง ูุฒู ุงูุฃูุฑ
   ```

---

#### 7. ุงููุชุฑุฉ ุงูุฒูููุฉ ุบูุฑ ูุณุชุฎุฑุฌุฉ

**ุงููุดููุฉ:**
ุฌููุน ุงููุดุงูุฏ ุชุธูุฑ ุจู "ุบูุฑ ูุญุฏุฏ".

**ุงูุญู:**
1. ุชุฃูุฏ ูู ูุฌูุฏ ุณููุงุช ูู ุงููุต ุจุงูุชูุณูู ุงูุตุญูุญ (ูุซู: 1986, 2009)
2. ุชุญูู ูู ุฃู ุงูุณููุงุช ุถูู ุงููุทุงู 1900-2099
3. ุฃุถู ุงูุณููุงุช ูุฏููุงู ูู ุนูุงููู ุงููุดุงูุฏ

---

### ุณุฌูุงุช ุงูุฃุฎุทุงุก

#### ุชูุนูู ุงูุชุณุฌูู ุงูุชูุตููู
```python
import logging

# ุชูุนูู ุงูุชุณุฌูู ุงูุชูุตููู
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('debug.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
```

#### ุฃูุงูู ูููุงุช ุงูุณุฌู
```
output_dir/
โโโ processing.log      # ุณุฌู ุงููุนุงูุฌุฉ ุงูุนุงู
โโโ entity_merge_log.json  # ุณุฌู ุชูุญูุฏ ุงูููุงูุงุช
โโโ quality_filter.log  # ุณุฌู ููุชุฑุฉ ุงูุฌูุฏุฉ
โโโ errors.log          # ุณุฌู ุงูุฃุฎุทุงุก
```

---

## ุงููุฑุฌุน ุงูููู

### ุงููุญุฏุงุช ูุงููุฆุงุช

#### screenplay_to_dataset1.py

| ุงููุฆุฉ | ุงููุตู |
|------|-------|
| `DialogueTurn` | ูููุฐุฌ ุจูุงูุงุช ุงูุญูุงุฑ ุงููุงุญุฏ |
| `Scene` | ูููุฐุฌ ุจูุงูุงุช ุงููุดูุฏ |
| `TextFileIngestor` | ูุฑุงุกุฉ ูููุงุช TXT |
| `DoclingIngestor` | ูุฑุงุกุฉ ูููุงุช PDF |
| `ScreenplayParser` | ุชุญููู ุงูุณููุงุฑูููุงุช |
| `AIEnricher` | ุฅุซุฑุงุก ุงูุจูุงูุงุช ุจุงูุชุถูููุงุช ูุงููุดุงุนุฑ |
| `DatasetExporter` | ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจุตูุบ ูุชุนุฏุฏุฉ |
| `GeminiAnalyzer` | ุชุญููู ูุชูุฏู ุจุงุณุชุฎุฏุงู Gemini |
| `EntityCanonicalizer` | ุชูุญูุฏ ุฃุณูุงุก ุงูุดุฎุตูุงุช (v4.0) |
| `QualityFilter` | ููุชุฑุฉ ุงูุญูุงุฑุงุช ููุฎูุถุฉ ุงูุฌูุฏุฉ (v4.0) |

### ุงูุฏูุงู ุงููุณุงุนุฏุฉ

| ุงูุฏุงูุฉ | ุงููุตู |
|--------|-------|
| `normalize_arabic(text)` | ุชุทุจูุน ุงููุตูุต ุงูุนุฑุจูุฉ |
| `count_arabic_words(text)` | ุนุฏ ุงููููุงุช ุงูุนุฑุจูุฉ |
| `safe_import(module_name)` | ุงุณุชูุฑุงุฏ ุขูู ููููุชุจุงุช |

### ุตูุบ ุงููููุงุช ุงููุฎุฑุฌุฉ

#### Alpaca (contextual_alpaca.json)
```json
[
  {
    "instruction": "ุฃููู ุงูุญูุงุฑ ุงูุชุงูู...",
    "input": "ุงูููุงู: ... ุงููุชุญุฏุซ: ...",
    "output": "ูุต ุงูุฑุฏ"
  }
]
```

#### ShareGPT (sharegpt.json)
```json
[
  {
    "conversations": [
      {"from": "human", "value": "..."},
      {"from": "gpt", "value": "..."}
    ]
  }
]
```

#### JSONL (rag_scenes.jsonl)
```json
{"scene_id": "S0001", "heading": "...", "time_period": "1986", ...}
```

#### CSV (dialogues.csv)
```csv
scene_id,turn_id,speaker,text,sentiment,sentiment_score
S0001,1,ุฃุญูุฏ,ููู ุญุงููุ,positive,0.8
```

---

## ุงูููุญูุงุช

### ุฃ. ุงููุชุทูุจุงุช ุงููุงููุฉ

```
# requirements.txt
pandas>=1.5.0
networkx>=2.8.0
sentence-transformers>=2.2.0
transformers>=4.20.0
rapidfuzz>=3.0.0
hypothesis>=6.0.0
google-genai>=0.3.0  # ุงุฎุชูุงุฑู
docling>=1.0.0       # ุงุฎุชูุงุฑู
```

### ุจ. ูููู ุงููุดุฑูุน

```
PREPA/
โโโ screenplay_to_dataset1.py    # ุงููุธุงู ุงูุฑุฆูุณู
โโโ screenplay_to_dataset.py     # ุงููุณุฎุฉ ุงููุฏููุฉ
โโโ docling_full_pipeline.py     # ูุนุงูุฌ PDF
โโโ script_dataset_builder.py    # ูุนุงูุฌ ุฃุณุงุณู
โโโ txt_to_pdf_converter.py      # ูุญูู ุงููููุงุช
โโโ docs/
โ   โโโ FEATURES_GUIDE.md        # ูุฐุง ุงูุฏููู
โโโ .kiro/specs/al-rawi-v4/
โ   โโโ design.md               # ูุซููุฉ ุงูุชุตููู
โ   โโโ requirements.md         # ุงููุชุทูุจุงุช
โ   โโโ tasks.md                # ุฎุทุฉ ุงูุชุทููุฑ
โโโ output/                      # ูุฌูุฏ ุงููุฎุฑุฌุงุช
```

### ุฌ. ุงูุชุฑุฎูุต ูุงููุณุงููุฉ

ูููุณุงููุฉ ูู ุชุทููุฑ ุงููุธุงูุ ูุฑุฌู ูุฑุงุฌุนุฉ:
- ูุซููุฉ ุงูุชุตููู: `.kiro/specs/al-rawi-v4/design.md`
- ุฎุทุฉ ุงูุชุทููุฑ: `.kiro/specs/al-rawi-v4/tasks.md`

---

*ุขุฎุฑ ุชุญุฏูุซ: ุฏูุณูุจุฑ 2025 - ุงูุฅุตุฏุงุฑ 4.0*
